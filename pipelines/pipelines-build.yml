template: true
valuesFilePath: ./values-build.yml

resources:
  # GitRepo
  - name: {{ .Values.gitRepo.name }}
    type: GitRepo
    configuration:
      gitProvider: {{ .Values.gitRepo.provider }}
      path: {{ .Values.gitRepo.path }}
      files:
        include: {{ .Values.gitRepo.files.include }}
      # branches:
      #   include: main

  # Build Info
  - name: {{ .Values.pipelines.name }}
    type: BuildInfo
    configuration:
      sourceArtifactory: {{ .Values.artifactory }}
      # buildName and buildNumber are used for inputResources
      # but these are overwritten with pipelines name when creating (as outputResources)
      # buildName: {{ .Values.build.name }}


pipelines:
  - name: {{ .Values.pipelines.name }}
    steps:
      - name: go_build
        type: GoBuild
        configuration:
          # sourceLocation: .
          # outputLocation: .
          outputFile: {{ .Values.application.name }}
          resolverRepo: {{ .Values.artifactoryRepo.resolver.name }}

          integrations:
            - name: {{ .Values.artifactory }}
          inputResources:
            - name: {{ .Values.gitRepo.name }}

      - name: go_publish_binary
        type: GoPublishBinary
        configuration:
          forceXrayScan: true
          autoPublishBuildInfo: true
          targetRepository: {{ .Values.artifactoryRepo.deployer.name }}

          integrations:
            - name: {{ .Values.artifactory }}
          outputResources:
            - name: {{ .Values.pipelines.name }}
          inputSteps:
            - name: go_build
          
      # - name: publish_build_info
      #   type: PublishBuildInfo
      #   configuration:
      #     inputSteps:
      #       - name: go_publish_binary
      #     outputResources:
      #       - name: {{ .Values.pipelines.name }}
